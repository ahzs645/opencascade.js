# Custom OpenCascade.js Build Configuration for Stepifi
# Purpose: Minimal build for STL/3MF/F3D to STEP/STL conversion
#
# IMPORTANT: Symbol names must match pre-compiled bindings (no _N suffixes)
#
# Build with: depot build -f Dockerfile.stepifi --platform linux/amd64 --target artifacts --output type=local,dest=./dist .

mainBuild:
  name: opencascade.stepifi.js
  bindings:
    # ===== Core Topology (TopoDS) =====
    - symbol: TopoDS
    - symbol: TopoDS_Shape
    - symbol: TopoDS_Solid
    - symbol: TopoDS_Shell
    - symbol: TopoDS_Face
    - symbol: TopoDS_Edge
    - symbol: TopoDS_Vertex
    - symbol: TopoDS_Wire
    - symbol: TopoDS_Compound
    - symbol: TopoDS_Builder
    - symbol: TopoDS_Iterator

    # ===== Topology Builders =====
    - symbol: BRepBuilderAPI_Command
    - symbol: BRepBuilderAPI_MakeShape
    - symbol: BRepBuilderAPI_MakeEdge
    - symbol: BRepBuilderAPI_MakeFace
    - symbol: BRepBuilderAPI_MakeShell
    - symbol: BRepBuilderAPI_MakeSolid
    - symbol: BRepBuilderAPI_MakeWire
    - symbol: BRepBuilderAPI_Sewing
    - symbol: BRep_Builder
    - symbol: BRep_Tool

    # ===== Topology Exploration =====
    - symbol: TopExp
    - symbol: TopExp_Explorer
    - symbol: TopAbs_ShapeEnum
    - symbol: TopAbs_Orientation

    # ===== Geometry Points/Directions/Axes =====
    - symbol: gp
    - symbol: gp_Pnt
    - symbol: gp_Pnt2d
    - symbol: gp_Vec
    - symbol: gp_Vec2d
    - symbol: gp_Dir
    - symbol: gp_Dir2d
    - symbol: gp_Ax1
    - symbol: gp_Ax2
    - symbol: gp_Ax2d
    - symbol: gp_Ax3
    - symbol: gp_XYZ
    - symbol: gp_Trsf

    # ===== Analytical Geometry =====
    - symbol: gp_Pln
    - symbol: gp_Lin
    - symbol: gp_Lin2d
    - symbol: gp_Circ
    - symbol: gp_Circ2d
    - symbol: gp_Elips
    - symbol: gp_Elips2d
    - symbol: gp_Cone
    - symbol: gp_Cylinder
    - symbol: gp_Sphere
    - symbol: gp_Torus

    # ===== Base Geometry =====
    - symbol: Geom_Geometry
    - symbol: Handle_Geom_Geometry

    # ===== 3D Curves =====
    - symbol: Geom_Curve
    - symbol: Handle_Geom_Curve
    - symbol: Geom_BoundedCurve
    - symbol: Handle_Geom_BoundedCurve
    - symbol: Geom_BSplineCurve
    - symbol: Handle_Geom_BSplineCurve
    - symbol: Geom_TrimmedCurve
    - symbol: Handle_Geom_TrimmedCurve
    - symbol: Geom_Conic
    - symbol: Handle_Geom_Conic
    - symbol: Geom_Line
    - symbol: Handle_Geom_Line
    - symbol: Geom_Circle
    - symbol: Handle_Geom_Circle
    - symbol: Geom_Ellipse
    - symbol: Handle_Geom_Ellipse
    - symbol: Geom_Parabola
    - symbol: Handle_Geom_Parabola
    - symbol: Geom_Hyperbola
    - symbol: Handle_Geom_Hyperbola

    # ===== 2D Curves =====
    - symbol: Geom2d_Geometry
    - symbol: Handle_Geom2d_Geometry
    - symbol: Geom2d_Curve
    - symbol: Handle_Geom2d_Curve
    - symbol: Geom2d_BoundedCurve
    - symbol: Handle_Geom2d_BoundedCurve
    - symbol: Geom2d_BSplineCurve
    - symbol: Handle_Geom2d_BSplineCurve
    - symbol: Geom2d_TrimmedCurve
    - symbol: Handle_Geom2d_TrimmedCurve
    - symbol: Geom2d_Conic
    - symbol: Handle_Geom2d_Conic
    - symbol: Geom2d_Line
    - symbol: Handle_Geom2d_Line
    - symbol: Geom2d_Circle
    - symbol: Handle_Geom2d_Circle
    - symbol: Geom2d_Ellipse
    - symbol: Handle_Geom2d_Ellipse

    # ===== Surfaces =====
    - symbol: Geom_Surface
    - symbol: Handle_Geom_Surface
    - symbol: Geom_BoundedSurface
    - symbol: Handle_Geom_BoundedSurface
    - symbol: Geom_BSplineSurface
    - symbol: Handle_Geom_BSplineSurface
    - symbol: Geom_ElementarySurface
    - symbol: Handle_Geom_ElementarySurface
    - symbol: Geom_Plane
    - symbol: Handle_Geom_Plane
    - symbol: Geom_CylindricalSurface
    - symbol: Handle_Geom_CylindricalSurface
    - symbol: Geom_SphericalSurface
    - symbol: Handle_Geom_SphericalSurface
    - symbol: Geom_ToroidalSurface
    - symbol: Handle_Geom_ToroidalSurface
    - symbol: Geom_ConicalSurface
    - symbol: Handle_Geom_ConicalSurface
    - symbol: Geom_SurfaceOfRevolution
    - symbol: Handle_Geom_SurfaceOfRevolution
    - symbol: Geom_OffsetSurface
    - symbol: Handle_Geom_OffsetSurface
    - symbol: Geom_SweptSurface
    - symbol: Handle_Geom_SweptSurface
    - symbol: Geom_SurfaceOfLinearExtrusion
    - symbol: Handle_Geom_SurfaceOfLinearExtrusion
    - symbol: Geom_RectangularTrimmedSurface
    - symbol: Handle_Geom_RectangularTrimmedSurface

    # ===== Collections for B-Splines =====
    - symbol: TColgp_Array1OfPnt
    - symbol: TColgp_Array1OfPnt2d
    - symbol: TColgp_Array2OfPnt
    - symbol: TColStd_Array1OfReal
    - symbol: TColStd_Array1OfInteger
    - symbol: TColStd_Array2OfReal

    # ===== Shape Repair =====
    - symbol: ShapeFix
    - symbol: ShapeFix_Shape
    - symbol: Handle_ShapeFix_Shape
    - symbol: ShapeFix_Root
    - symbol: Handle_ShapeFix_Root
    - symbol: ShapeFix_Shell
    - symbol: Handle_ShapeFix_Shell
    - symbol: ShapeFix_Face
    - symbol: Handle_ShapeFix_Face
    - symbol: ShapeFix_Wire
    - symbol: Handle_ShapeFix_Wire
    - symbol: ShapeUpgrade_UnifySameDomain

    # ===== Shape Analysis =====
    - symbol: BRepCheck_Analyzer
    - symbol: BRepGProp
    - symbol: GProp_GProps
    - symbol: BRepBndLib
    - symbol: Bnd_Box

    # ===== Mesh Generation =====
    - symbol: BRepMesh_IncrementalMesh
    - symbol: Poly_Triangulation
    - symbol: Handle_Poly_Triangulation

    # ===== Location/Transformation =====
    - symbol: TopLoc_Location

    # ===== STEP I/O =====
    # NOTE: STEP writing requires many internal classes that can't be
    # bound in a minimal build. The code falls back to BREP export.
    # For full STEP support, use the full 50MB build.
    - symbol: STEPControl_Writer
    - symbol: STEPControl_Reader
    - symbol: STEPControl_StepModelType
    - symbol: IFSelect_ReturnStatus

    # ===== STL I/O =====
    - symbol: StlAPI
    - symbol: StlAPI_Reader
    - symbol: StlAPI_Writer

    # ===== BREP I/O =====
    - symbol: BRepTools

    # ===== Progress Tracking =====
    - symbol: Message_ProgressRange

    # ===== Standard Types =====
    - symbol: Standard_Transient
    - symbol: Handle_Standard_Transient

    # ===== String Handling =====
    - symbol: TCollection_AsciiString
    - symbol: TCollection_ExtendedString

    # ===== Shape Collections =====
    - symbol: TopTools_ListOfShape

  emccFlags:
    - -flto
    - -fexceptions
    - -O3
    - -sEXPORT_ES6=1
    - -sUSE_ES6_IMPORT_META=0
    - -sEXPORTED_RUNTIME_METHODS=['FS']
    - -sINITIAL_MEMORY=32MB
    - -sMAXIMUM_MEMORY=4GB
    - -sALLOW_MEMORY_GROWTH=1
    - -sENVIRONMENT='web,worker'

# No additional C++ code - Stepifi uses virtual filesystem for I/O
