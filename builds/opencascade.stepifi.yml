# Custom OpenCascade.js Build Configuration for Stepifi
# Purpose: Minimal build for STL/3MF/F3D to STEP/STL conversion
#
# This configuration includes bindings for:
# - Shape creation and topology building
# - B-spline curves and surfaces (for F3D/ACIS support)
# - Shape repair and face merging
# - Shape analysis (bounding box, volume, area)
# - STEP/STL I/O
#
# Build with: python src/buildFromYaml.py builds/opencascade.stepifi.yml

mainBuild:
  name: opencascade.stepifi.js
  bindings:
    # ===== Core Topology (TopoDS) =====
    - symbol: TopoDS_Shape
    - symbol: TopoDS_Solid
    - symbol: TopoDS_Shell
    - symbol: TopoDS_Face
    - symbol: TopoDS_Edge
    - symbol: TopoDS_Vertex
    - symbol: TopoDS_Wire
    - symbol: TopoDS_Compound
    - symbol: TopoDS
    - symbol: TopoDS_Builder

    # ===== Topology Builders =====
    - symbol: BRepBuilderAPI_MakeEdge
    - symbol: BRepBuilderAPI_MakeFace
    - symbol: BRepBuilderAPI_MakeShell
    - symbol: BRepBuilderAPI_MakeSolid
    - symbol: BRepBuilderAPI_MakeWire
    - symbol: BRepBuilderAPI_Command
    - symbol: BRepBuilderAPI_MakeShape
    - symbol: BRep_Builder
    - symbol: BRep_Tool

    # ===== Topology Exploration =====
    - symbol: TopExp_Explorer
    - symbol: TopExp_Explorer_2
    - symbol: TopAbs_ShapeEnum
    - symbol: TopAbs_COMPOUND
    - symbol: TopAbs_COMPSOLID
    - symbol: TopAbs_SOLID
    - symbol: TopAbs_SHELL
    - symbol: TopAbs_FACE
    - symbol: TopAbs_WIRE
    - symbol: TopAbs_EDGE
    - symbol: TopAbs_VERTEX
    - symbol: TopAbs_SHAPE
    - symbol: TopAbs_Orientation

    # ===== Geometry Points/Directions/Axes =====
    - symbol: gp_Pnt
    - symbol: gp_Pnt2d
    - symbol: gp_Vec
    - symbol: gp_Vec2d
    - symbol: gp_Dir
    - symbol: gp_Dir2d
    - symbol: gp_Ax1
    - symbol: gp_Ax2
    - symbol: gp_Ax2d
    - symbol: gp_Ax3
    - symbol: gp_XYZ
    - symbol: gp_Trsf
    - symbol: gp

    # ===== Analytical Curves =====
    - symbol: gp_Lin
    - symbol: gp_Lin2d
    - symbol: gp_Circ
    - symbol: gp_Circ2d
    - symbol: gp_Elips
    - symbol: gp_Elips2d
    - symbol: Geom_Line
    - symbol: Geom_Circle
    - symbol: Geom_Ellipse
    - symbol: Geom2d_Line
    - symbol: Geom2d_Circle
    - symbol: Geom2d_Ellipse

    # ===== B-Spline Curves (3D) =====
    - symbol: Geom_BSplineCurve
    - symbol: Geom_Curve
    - symbol: Geom_BoundedCurve
    - symbol: Geom_TrimmedCurve
    - symbol: Geom_Geometry
    - symbol: Handle_Geom_Curve
    - symbol: Handle_Geom_BSplineCurve
    - symbol: Handle_Geom_TrimmedCurve

    # ===== B-Spline Curves (2D - for parametric curves) =====
    - symbol: Geom2d_BSplineCurve
    - symbol: Geom2d_Curve
    - symbol: Geom2d_BoundedCurve
    - symbol: Geom2d_TrimmedCurve
    - symbol: Geom2d_Geometry
    - symbol: Geom2d_Conic
    - symbol: Handle_Geom2d_Curve
    - symbol: Handle_Geom2d_BSplineCurve
    - symbol: Handle_Geom2d_TrimmedCurve

    # ===== B-Spline Surfaces =====
    - symbol: Geom_BSplineSurface
    - symbol: Geom_Surface
    - symbol: Geom_BoundedSurface
    - symbol: Geom_Plane
    - symbol: Geom_ElementarySurface
    - symbol: Handle_Geom_Surface
    - symbol: Handle_Geom_BSplineSurface
    - symbol: Handle_Geom_Plane

    # ===== Additional Surfaces (for ACIS/F3D support) =====
    - symbol: Geom_CylindricalSurface
    - symbol: Geom_SphericalSurface
    - symbol: Geom_ToroidalSurface
    - symbol: Geom_ConicalSurface
    - symbol: Geom_RectangularTrimmedSurface
    - symbol: Handle_Geom_CylindricalSurface
    - symbol: Handle_Geom_SphericalSurface
    - symbol: Handle_Geom_ToroidalSurface
    - symbol: Handle_Geom_ConicalSurface

    # ===== Collections for B-Splines =====
    - symbol: TColgp_Array1OfPnt
    - symbol: TColgp_Array1OfPnt2d
    - symbol: TColgp_Array2OfPnt
    - symbol: TColStd_Array1OfReal
    - symbol: TColStd_Array1OfInteger
    - symbol: TColStd_Array2OfReal

    # ===== Shape Repair =====
    - symbol: ShapeFix_Shape
    - symbol: ShapeFix_Root
    - symbol: ShapeFix_Shell
    - symbol: ShapeFix_Face
    - symbol: ShapeFix_Wire
    - symbol: ShapeUpgrade_UnifySameDomain

    # ===== Shape Analysis =====
    - symbol: BRepCheck_Analyzer
    - symbol: BRepCheck_Status
    - symbol: BRepGProp
    - symbol: GProp_GProps
    - symbol: BRepBndLib
    - symbol: Bnd_Box

    # ===== Mesh Generation =====
    - symbol: BRepMesh_IncrementalMesh
    - symbol: BRepMesh_IncrementalMesh_2
    - symbol: BRepMesh_DiscretRoot
    - symbol: Poly_Triangulation
    - symbol: Handle_Poly_Triangulation

    # ===== Location/Transformation =====
    - symbol: TopLoc_Location
    - symbol: TopLoc_Location_1

    # ===== STEP I/O =====
    - symbol: STEPControl_Writer
    - symbol: STEPControl_Reader
    - symbol: STEPControl_StepModelType
    - symbol: IFSelect_ReturnStatus
    - symbol: IFSelect_RetDone
    - symbol: IFSelect_RetVoid
    - symbol: IFSelect_RetFail
    - symbol: IFSelect_RetError

    # ===== STL I/O =====
    - symbol: StlAPI
    - symbol: StlAPI_Reader
    - symbol: StlAPI_Writer

    # ===== BREP I/O =====
    - symbol: BRepTools

    # ===== Progress Tracking =====
    - symbol: Message_ProgressRange

    # ===== Standard Types =====
    - symbol: Standard_Transient
    - symbol: Handle_Standard_Transient
    - symbol: Standard_Failure

    # ===== String Handling =====
    - symbol: TCollection_AsciiString
    - symbol: TCollection_ExtendedString

    # ===== Shape Collections/Iterators =====
    - symbol: TopTools_ListOfShape
    - symbol: TopoDS_Iterator

    # ===== Custom Helper Classes =====
    - symbol: OCJS
    - symbol: OCJS_IO

  emccFlags:
    - -flto
    - -fexceptions
    - -O3
    - -sEXPORT_ES6=1
    - -sUSE_ES6_IMPORT_META=0
    - -sEXPORTED_RUNTIME_METHODS=['FS']
    - -sINITIAL_MEMORY=32MB
    - -sMAXIMUM_MEMORY=4GB
    - -sALLOW_MEMORY_GROWTH=1
    - -sENVIRONMENT='web,worker'

additionalCppCode: |
  #include <sstream>
  #include <string>
  #include <BRepTools.hxx>
  #include <TopoDS_Shape.hxx>
  #include <STEPControl_Writer.hxx>
  #include <StlAPI.hxx>

  // Helper class for exception handling
  class OCJS {
  public:
    static Standard_Failure* getStandard_FailureData(intptr_t exceptionPtr) {
      return reinterpret_cast<Standard_Failure*>(exceptionPtr);
    }
  };

  // String-based I/O wrappers for methods that use Standard_OStream
  // These avoid the "unbound types: std::basic_ostream<...>" error
  class OCJS_IO {
  public:
    // BRepTools::Write (ostream overload) -> std::string
    static std::string BRep_WriteToString(const TopoDS_Shape& shape) {
      std::ostringstream ss;
      BRepTools::Write(shape, ss);
      return ss.str();
    }

    // TopoDS_Shape::DumpJson -> std::string
    static std::string Shape_DumpJsonToString(const TopoDS_Shape& shape, Standard_Integer depth = -1) {
      std::ostringstream ss;
      shape.DumpJson(ss, depth);
      return ss.str();
    }

    // TopoDS_Shape::Dump -> std::string
    static std::string Shape_DumpToString(const TopoDS_Shape& shape) {
      std::ostringstream ss;
      shape.Dump(ss);
      return ss.str();
    }
  };
